{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Skill Contract (skill/v1)",
  "type": "object",
  "required": [
    "apiVersion",
    "kind",
    "id",
    "name",
    "version",
    "description",
    "governance",
    "runtime",
    "io",
    "determinism",
    "security",
    "observability"
  ],
  "properties": {
    "apiVersion": { "type": "string", "const": "skill/v1" },
    "kind": { "type": "string", "const": "Skill" },
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*(\\.[a-z][a-z0-9_]*)*$"
    },
    "name": { "type": "string", "minLength": 1 },
    "version": {
      "type": "string",
      "pattern": "^([0-9]+)\\.([0-9]+)\\.([0-9]+)(-[0-9A-Za-z.-]+)?(\\+[0-9A-Za-z.-]+)?$"
    },
    "description": { "type": "string", "minLength": 1 },
    "governance": {
      "type": "object",
      "required": ["specId", "oneSkillPerCommit"],
      "properties": {
        "specId": { "type": "string", "minLength": 1 },
        "oneSkillPerCommit": { "type": "boolean", "const": true },
        "concepts": { "type": "array", "items": { "type": "string", "minLength": 1 } },
        "synchronizations": { "type": "array", "items": { "type": "string", "minLength": 1 } }
      },
      "additionalProperties": false
    },
    "runtime": {
      "type": "object",
      "required": ["type", "command"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["command", "python", "node", "shell"]
        },
        "command": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1,
            "pattern": "^(?!/)(?!.*\\.{2}).+$"
          }
        },
        "cwd": { "type": "string", "pattern": "^(?!/)(?!.*\\.{2}).+$" },
        "timeoutMs": { "type": "integer", "minimum": 1, "maximum": 3600000 }
      },
      "additionalProperties": false
    },
    "io": {
      "type": "object",
      "required": ["inputSchema", "outputSchema", "input", "output"],
      "properties": {
        "inputSchema": { "type": "string", "pattern": "^(?!/)(?!.*\\.{2}).+$" },
        "outputSchema": { "type": "string", "pattern": "^(?!/)(?!.*\\.{2}).+$" },
        "input": {
          "type": "object",
          "required": ["transport", "encoding"],
          "properties": {
            "transport": { "type": "string", "const": "stdin" },
            "encoding": { "type": "string", "const": "json" }
          },
          "additionalProperties": false
        },
        "output": {
          "type": "object",
          "required": ["transport", "encoding"],
          "properties": {
            "transport": { "type": "string", "const": "stdout" },
            "encoding": { "type": "string", "const": "json" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "determinism": {
      "type": "object",
      "required": ["network", "time", "randomness"],
      "properties": {
        "network": { "type": "string", "enum": ["forbidden", "allowed"] },
        "time": { "type": "string", "enum": ["forbidden", "input_only"] },
        "randomness": { "type": "string", "enum": ["forbidden", "seeded"] }
      },
      "additionalProperties": false
    },
    "security": {
      "type": "object",
      "required": ["access"],
      "properties": {
        "access": {
          "type": "object",
          "required": ["filesystem", "env", "subprocess", "network"],
          "properties": {
            "filesystem": {
              "type": "object",
              "required": ["read", "write"],
              "properties": {
                "read": { "type": "array", "items": { "type": "string", "minLength": 1 } },
                "write": { "type": "array", "items": { "type": "string", "minLength": 1 } }
              },
              "additionalProperties": false
            },
            "env": {
              "type": "object",
              "required": ["read"],
              "properties": {
                "read": { "type": "array", "items": { "type": "string", "minLength": 1 } }
              },
              "additionalProperties": false
            },
            "subprocess": {
              "type": "object",
              "required": ["allowed"],
              "properties": { "allowed": { "type": "boolean" } },
              "additionalProperties": false
            },
            "network": {
              "type": "object",
              "required": ["allowed"],
              "properties": { "allowed": { "type": "boolean" } },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "observability": {
      "type": "object",
      "required": ["logs", "runReport"],
      "properties": {
        "logs": {
          "type": "object",
          "required": ["format", "destination"],
          "properties": {
            "format": { "type": "string", "enum": ["jsonl", "text"] },
            "destination": { "type": "string", "enum": ["stderr", "file"] }
          },
          "additionalProperties": false
        },
        "runReport": {
          "type": "object",
          "required": ["enabled"],
          "properties": { "enabled": { "type": "boolean", "const": true } },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "patternProperties": {
    "^x-": {}
  },
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": {
          "determinism": {
            "properties": { "network": { "const": "allowed" } },
            "required": ["network"]
          }
        },
        "required": ["determinism"]
      },
      "then": {
        "properties": {
          "security": {
            "properties": {
              "access": {
                "properties": {
                  "network": {
                    "properties": { "allowed": { "const": true } },
                    "required": ["allowed"]
                  }
                },
                "required": ["network"]
              }
            },
            "required": ["access"]
          }
        },
        "required": ["security", "x-securityApprovalId"]
      }
    },
    {
      "if": {
        "properties": {
          "determinism": {
            "properties": { "network": { "const": "forbidden" } },
            "required": ["network"]
          }
        },
        "required": ["determinism"]
      },
      "then": {
        "properties": {
          "security": {
            "properties": {
              "access": {
                "properties": {
                  "network": {
                    "properties": { "allowed": { "const": false } },
                    "required": ["allowed"]
                  }
                },
                "required": ["network"]
              }
            },
            "required": ["access"]
          }
        },
        "required": ["security"]
      }
    }
  ]
}

